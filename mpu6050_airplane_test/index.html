<!DOCTYPE html>
<head> 
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style> 
      model-viewer{
            width: 800px;
            height: 600px; 
            margin: 0 uato;
      }
   </style>
</head>
<html>
 <body>
  <div>
      <h2 align='left' style='color:blue'>‰ΩøÁî® 3D Ê®°Âûã‰æÜÊ∏¨Ë©¶ MPU6050 </h2>
  </div>
    <button id="SerialConnectButton">1 - ÈÅ∏ÊìáÈÄ£ÁµêÁöÑÂ∫èÂàóÂü†</button>
    <!--label>ÈúÄÈñãÂïü chrome://flags/#enable-experimental-web-platform-features</label-->
    <div class="container">
         <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
          <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./DamagedHelmet.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair"-->
            <model-viewer id="transform" orientation="0 0 -90" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./airplane.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair">
            </div>
      </model-viewer>
          </div>
  </body>  
<script>
/*
 * Web Serial API (Google Chrome)
 *
 * Useful information used to this implementation:
 * https://github.com/svendahlstrand/web-serial-api/
 * https://dev.to/unjavascripter/the-amazing-powers-of-the-web-web-serial-api-3ilc
 *
 */

 const connectButton = document.getElementById ('SerialConnectButton');
let port;

if ('serial' in navigator) {
  connectButton.addEventListener('click', function () {
    if (port) {
      port = undefined;
      connectButton.innerText = 'Connect';

      document.getElementById('SerialSpeed').disabled = false;

    }
    else {
      connectButton.innerText = 'Disconnect';
      getReader();
	//  requestSerialPort()
    }
  });

  connectButton.disabled = false;
}
else {
  const error = document.createElement('p');
  error.innerHTML = '<p>Support for Serial Web API not enabled. Please enable it using chrome://flags/ and enable Experimental Web Platform fetures</p>';

}

let lineBuffer = '';
let latestValue = 0;

	  let decoder = new TextDecoderStream();
 // port.readable.pipeTo(decoder.writable);
  const reader = decoder.readable.getReader();

async function serialWrite(data) {
	encoder = new TextEncoder();
	const dataArrayBuffer = encoder.encode(data);

	if (port && port.writable) {
		const writer = port.writable.getWriter();
		writer.write(dataArrayBuffer);
		writer.releaseLock();
	}
}

class LineBreakTransformer {
  constructor() {
    // A container for holding stream data until a new line.
    this.chunks = "";
  }

  transform(chunk, controller) {
    // Append new chunks to existing chunks.
    this.chunks += chunk;
    // For each line breaks in chunks, send the parsed lines out.
    const lines = this.chunks.split("\r\n");
    this.chunks = lines.pop();
  //  console.log(this.chunks);
    lines.forEach((line) => controller.enqueue(line));
  }

  flush(controller) {
    // When the stream is closed, flush any remaining chunks out.
    controller.enqueue(this.chunks);
  }
}

async function getReader(){const e=[{usbVendorId:9025,usbProductId:67},{usbVendorId:1659}];port=await navigator.serial.requestPort({filters:e}),await port.open({baudRate:115200}),connectButton.innerText="Disconnect",console.log("[31mConnected using Web Serial API ![m\r\n");const r=new TextDecoderStream,n=port.readable.pipeTo(r.writable),o=r.readable.pipeThrough(new TransformStream(new LineBreakTransformer)).getReader();for(;port.readable;)try{for(;;){const{value:e,done:r}=await o.read();if(r){o.releaseLock();break}if(e.includes("{")&&e.includes("}")){let r=e;const n=r.indexOf("{"),o=r.indexOf("}");r=r.slice(n,o+1);try{const{y:e,p:n,r:o}=JSON.parse(r);modelViewerTransform.orientation=`${n}deg ${-o}deg ${e-90}deg`}catch(e){console.log(e)}r=""}}}catch(e){}}
  
 //   const myArr = str.split(" ", 2);
//document.getElementById("demo").innerHTML = myArr[1];

const modelViewerTransform = document.querySelector("model-viewer#transform");
</script>
</html>
