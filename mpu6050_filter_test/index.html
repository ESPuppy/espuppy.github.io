<!DOCTYPE html>
<head> 

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style> 
      model-viewer{
            width: 300px;
            height: 250px; 
            margin: 0 px;
            margin-right: 0px;
      }
      model-viewer#transform1 {
    --poster-color: transparent;
  }
      .container {
       height: 20px;
       position: relative;
      }

      .center {
        margin: 0;
        position: absolute;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
         transform: translate(-50%, -50%);
      }
    #wrapper { width:800px;  clear:both;}
    .divleft{ width:300px; height:200px; margin-right: 8px; background-color:#ffffff; float:left;}  
	  .middle{ width:300px; height:250px; margin-left: 0px; background-color:#ffffff; display:inline-block;}  
	   </style>
</head>
<html>
 <body>
  
  <div >
      <h2 align='center' style='color:blue'>觀察不同方式計算出角度值的差異</h2>
</div>
<div class="container">
  <div class="center">
    <button id="SerialConnectButton">選擇連結的序列埠</button>
    <!--label>需開啟 chrome://flags/#enable-experimental-web-platform-features</label-->
  </div>
</div>
  <div style="text-align:center" >
      <div class="middle">
        <h2 style='color:blue'>加速度</h2>
         <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
          <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./DamagedHelmet.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair"-->
        <model-viewer id="transform1" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair"> 
        </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>陀螺儀</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
          <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./DamagedHelmet.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair"-->
          <model-viewer id="transform2" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
          </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>一階互補濾波</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
      <model-viewer id="transform3" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
      </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>二階互補濾波</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
      <model-viewer id="transform4" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
      </model-viewer>
      </div>
    </div>       
  </body> 
<script>

/*
 * Web Serial API (Google Chrome)
 *
 * Useful information used to this implementation:
 * https://github.com/svendahlstrand/web-serial-api/
 * https://dev.to/unjavascripter/the-amazing-powers-of-the-web-web-serial-api-3ilc
 *
 */

const connectButton = document.getElementById ('SerialConnectButton');
let port;

if ('serial' in navigator) {
  connectButton.addEventListener('click', function () {
    if (port) {
      port = undefined;
      connectButton.innerText = 'Connect';

      document.getElementById('SerialSpeed').disabled = false;

    }
    else {
      connectButton.innerText = 'Disconnect';
      getReader();
	//  requestSerialPort()
    }
  });

  connectButton.disabled = false;
}
else {
  const error = document.createElement('p');
  error.innerHTML = '<p>Support for Serial Web API not enabled. Please enable it using chrome://flags/ and enable Experimental Web Platform fetures</p>';

}

let lineBuffer = '';
let latestValue = 0;

	  let decoder = new TextDecoderStream();
 // port.readable.pipeTo(decoder.writable);
  const reader = decoder.readable.getReader();


async function serialWrite(data) {
	encoder = new TextEncoder();
	const dataArrayBuffer = encoder.encode(data);

	if (port && port.writable) {
		const writer = port.writable.getWriter();
		writer.write(dataArrayBuffer);
		writer.releaseLock();
	}
}

class LineBreakTransformer {
  constructor() {
    // A container for holding stream data until a new line.
    this.chunks = "";
  }

  transform(chunk, controller) {
    // Append new chunks to existing chunks.
    this.chunks += chunk;
    // For each line breaks in chunks, send the parsed lines out.
    const lines = this.chunks.split("\r\n");
    this.chunks = lines.pop();
  //  console.log(this.chunks);
    lines.forEach((line) => controller.enqueue(line));
  }

  flush(controller) {
    // When the stream is closed, flush any remaining chunks out.
    controller.enqueue(this.chunks);
  }
}

async function getReader(){const e=[{usbVendorId:9025,usbProductId:67},{usbVendorId:1659}];port=await navigator.serial.requestPort({}),await port.open({baudRate:115200}),connectButton.innerText="Disconnect",console.log("Test MPU6050 !!");const r=new TextDecoderStream,o=port.readable.pipeTo(r.writable),a=r.readable.pipeThrough(new TransformStream(new LineBreakTransformer)).getReader();for(;port.readable;)try{for(;;){const{value:e,done:r}=await a.read();if(r){a.releaseLock();break}if(e.includes("{")&&e.includes("}")){let r=e;const o=r.indexOf("{"),a=r.indexOf("}");r=r.slice(o,a+1);try{const{ax:e,ay:o,az:a,gx:n,gy:t,gz:d,y:i,p:s,r:c,y2:g,p2:l,r2:f}=JSON.parse(r);modelViewerTransform1.orientation=`${-e}deg ${-o}deg ${a}deg`,modelViewerTransform2.orientation=`${-n}deg ${-t}deg ${d}deg`,modelViewerTransform3.orientation=`${-c}deg ${-s}deg ${i}deg`,modelViewerTransform4.orientation=`${-f}deg ${-l}deg ${g}deg`}catch(e){console.log(e)}r=""}}}catch(e){}}
	  
const modelViewerTransform1 = document.querySelector("model-viewer#transform1");
const modelViewerTransform2 = document.querySelector("model-viewer#transform2");
const modelViewerTransform3 = document.querySelector("model-viewer#transform3");
const modelViewerTransform4 = document.querySelector("model-viewer#transform4");

</script>
</html>
