<!DOCTYPE html>
<head> 

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style> 
      model-viewer{
            width: 300px;
            height: 250px; 
            margin: 0 px;
            margin-right: 0px;
      }
      model-viewer#transform1 {
    --poster-color: transparent;
  }
      .container {
       height: 20px;
       position: relative;
      }

      .center {
        margin: 0;
        position: absolute;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
         transform: translate(-50%, -50%);
      }
    #wrapper { width:800px;  clear:both;}
    .divleft{ width:300px; height:200px; margin-right: 8px; background-color:#ffffff; float:left;}  
	  .middle{ width:300px; height:250px; margin-left: 0px; background-color:#ffffff; display:inline-block;}  
	   </style>
</head>
<html>
 <body>
  
  <div >
      <h2 align='center' style='color:blue'>觀察不同方式計算出角度值的差異</h2>
</div>
<div class="container">
  <div class="center">
    <button id="SerialConnectButton">選擇連結的序列埠</button>
    <!--label>需開啟 chrome://flags/#enable-experimental-web-platform-features</label-->
  </div>
</div>
  <div style="text-align:center" >
      <div class="middle">
        <h2 style='color:blue'>加速度</h2>
         <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
          <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./DamagedHelmet.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair"-->
        <model-viewer id="transform1" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair"> 
        </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>陀螺儀</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
          <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./DamagedHelmet.glb" skybox-image="./spruit_sunrise_1k_HDR.hdr" alt="A 3D model of a chair"-->
          <model-viewer id="transform2" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
          </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>一階互補濾波</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
      <model-viewer id="transform3" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
      </model-viewer>
      </div>
      <div class="middle">
      <h2 style='color:blue'>二階互補濾波</h2>
      <!--model-viewer id="transform" orientation="0 0 0" camera-controls ar ar-modes="webxr scene-viewer quick-look" src="./Astronaut.glb" alt="A 3D model of a chair"-->
      <model-viewer id="transform4" orientation="0 0 0" disable-zoom ar ar-modes="webxr scene-viewer quick-look" src="./Dice.glb" alt="A 3D model of a chair">
      </model-viewer>
      </div>
    </div>       
  </body> 
<script>

/*
 * Web Serial API (Google Chrome)
 *
 * Useful information used to this implementation:
 * https://github.com/svendahlstrand/web-serial-api/
 * https://dev.to/unjavascripter/the-amazing-powers-of-the-web-web-serial-api-3ilc
 *
 */

const connectButton = document.getElementById ('SerialConnectButton');
let port;

if ('serial' in navigator) {
  connectButton.addEventListener('click', function () {
    if (port) {
      port = undefined;
      connectButton.innerText = 'Connect';

      document.getElementById('SerialSpeed').disabled = false;

    }
    else {
      connectButton.innerText = 'Disconnect';
      getReader();
	//  requestSerialPort()
    }
  });

  connectButton.disabled = false;
}
else {
  const error = document.createElement('p');
  error.innerHTML = '<p>Support for Serial Web API not enabled. Please enable it using chrome://flags/ and enable Experimental Web Platform fetures</p>';

}

let lineBuffer = '';
let latestValue = 0;

	  let decoder = new TextDecoderStream();
 // port.readable.pipeTo(decoder.writable);
  const reader = decoder.readable.getReader();


async function serialWrite(data) {
	encoder = new TextEncoder();
	const dataArrayBuffer = encoder.encode(data);

	if (port && port.writable) {
		const writer = port.writable.getWriter();
		writer.write(dataArrayBuffer);
		writer.releaseLock();
	}
}

class LineBreakTransformer {
  constructor() {
    // A container for holding stream data until a new line.
    this.chunks = "";
  }

  transform(chunk, controller) {
    // Append new chunks to existing chunks.
    this.chunks += chunk;
    // For each line breaks in chunks, send the parsed lines out.
    const lines = this.chunks.split("\r\n");
    this.chunks = lines.pop();
  //  console.log(this.chunks);
    lines.forEach((line) => controller.enqueue(line));
  }

  flush(controller) {
    // When the stream is closed, flush any remaining chunks out.
    controller.enqueue(this.chunks);
  }
}

async function getReader() {
  const filters = [
       { usbVendorId: 0x2341, usbProductId: 0x0043 },
       { usbVendorId: 0x067B}
   ];
    port = await navigator.serial.requestPort({filters});
    await port.open({ baudRate: 115200 });
    connectButton.innerText = 'Disconnect';
    console.log('Test MPU6050 !!');
		
    const textDecoder = new TextDecoderStream();
    const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
    const reader = textDecoder.readable
       .pipeThrough(new TransformStream(new LineBreakTransformer()))
       .getReader();
  
// Listen to data coming from the serial device.
while (port.readable) {
  //const reader = port.readable.getReader();
  try {
     while (true) {
        const { value, done } = await reader.read();
      if (done) {
         reader.releaseLock();
         break;
      }

      if (value.includes('{') && value.includes('}')) {
         let buffer = value; 
           // console.log(buffer);
           const start = buffer.indexOf('{');
           const end = buffer.indexOf('}');
           buffer = buffer.slice(start, end + 1);
           try {
               const { ax,ay,az,gx,gy,gz,y,p,r,y2,p2,r2 } = JSON.parse(buffer);
               modelViewerTransform1.orientation = `${-ax}deg ${-ay}deg ${az}deg`;
               modelViewerTransform2.orientation = `${-gx}deg ${-gy}deg ${gz}deg`;
               modelViewerTransform3.orientation = `${-r}deg ${-p}deg ${y}deg`;
               modelViewerTransform4.orientation = `${-r2}deg ${-p2}deg ${y2}deg`;
            } catch (err) {
              console.log(err);
            }
            buffer = '';
        }
      }
    } catch (error) {
    // 
    }
   } 
 }
	  
const modelViewerTransform1 = document.querySelector("model-viewer#transform1");
const modelViewerTransform2 = document.querySelector("model-viewer#transform2");
const modelViewerTransform3 = document.querySelector("model-viewer#transform3");
const modelViewerTransform4 = document.querySelector("model-viewer#transform4");

</script>
</html>